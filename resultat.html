<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©sultats du Vote (Transparence)</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        h1 { color: #333; }
        #results-container { 
            margin-top: 20px; 
            padding: 20px; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
        }
        .college-results { margin-bottom: 30px; border-left: 5px solid #007bff; padding-left: 15px; }
        .candidate-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #eee; }
        .candidate-name { font-weight: bold; }
        .vote-count { color: #007bff; font-weight: bold; }
        .total-votes-title { font-size: 1.2em; color: green; font-weight: bold; margin-bottom: 15px;}
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>

    <h1>üìä Tableau de Bord des R√©sultats Officiels (En temps r√©el)</h1>
    <p>Ce tableau affiche l'√©volution des votes en direct. Mise √† jour automatique.</p>

    <div id="results-container">
        <p>Chargement des r√©sultats...</p>
        <p id="total-voters-count" class="total-votes-title">Total des votants uniques: 0</p>
    </div>

    <script>
        // 3. CONFIGURATION ET INITIALISATION FIREBASE
        
        // Configuration utilis√©e : V√âRIFIEZ LA COH√âRENCE AVEC VOTRE FICHIER vote.js
        const firebaseConfig = {
            apiKey: "AIzaSyDBSeXQ9CKWSDhNup51XPL0FKEgQc7xiT8", 
            authDomain: "voteof2025.firebaseapp.com",
            projectId: "voteof2025",
            databaseURL: "https://voteof2025-default-rtdb.firebaseio.com", 
            storageBucket: "voteof2025.firebasestorage.app",
            messagingSenderId: "340380987924",
            appId: "1:340380987924:web:d1d38acc06d02a3bc42d01",
            measurementId: "G-HBN2JMS2M1"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = app.database();

        // -----------------------------------------------------------
        // 4. LOGIQUE DE CALCUL ET D'AFFICHAGE DES R√âSULTATS
        // -----------------------------------------------------------

        function fetchResults() {
            const resultsRef = database.ref('votes'); 
            const resultsContainer = document.getElementById('results-container');
            const totalVotersElement = document.getElementById('total-voters-count');

            // .on('value') √©coute les changements en temps r√©el
            resultsRef.on('value', (snapshot) => {
                
                resultsContainer.innerHTML = ''; // Nettoyage
                
                if (!snapshot.exists()) {
                    totalVotersElement.textContent = "Total des votants uniques: 0";
                    resultsContainer.innerHTML += '<p class="error">Aucun vote trouv√© dans la base de donn√©es.</p>';
                    resultsContainer.appendChild(totalVotersElement);
                    return;
                }

                const allVotes = snapshot.val();
                const counts = {}; 
                const uniqueVoters = new Set(); 

                // 1. Calcul des r√©sultats
                for (const key in allVotes) {
                    const voteRecord = allVotes[key];
                    const cleanUserId = voteRecord.cleanUserId;
                    
                    if (!uniqueVoters.has(cleanUserId)) {
                        uniqueVoters.add(cleanUserId);
                    }

                    const selections = voteRecord.selections;

                    for (const college in selections) {
                        if (!counts[college]) counts[college] = {};

                        for (const subCategory in selections[college]) {
                            const choiceId = selections[college][subCategory];
                            const keyName = `${college} - ${subCategory}`; 
                            
                            if (!counts[college][keyName]) counts[college][keyName] = {};

                            counts[college][keyName][choiceId] = (counts[college][keyName][choiceId] || 0) + 1;
                        }
                    }
                }

                // 2. Affichage
                totalVotersElement.textContent = `Total des votants uniques: ${uniqueVoters.size}`;
                resultsContainer.appendChild(totalVotersElement); 

                for (const college in counts) {
                    const collegeDiv = document.createElement('div');
                    collegeDiv.className = 'college-results';
                    collegeDiv.innerHTML = `<h2>Coll√®ge: ${college}</h2>`;
                    
                    for (const keyName in counts[college]) {
                        const categoryName = keyName.split(' - ')[1];
                        
                        collegeDiv.innerHTML += `<h3>Cat√©gorie: ${categoryName}</h3>`;
                        
                        const sortedChoices = Object.entries(counts[college][keyName])
                            .sort(([, a], [, b]) => b - a);

                        sortedChoices.forEach(([choiceId, voteCount]) => {
                            const row = document.createElement('div');
                            row.className = 'candidate-row';
                            row.innerHTML = `
                                <span class="candidate-name">${choiceId}</span>
                                <span class="vote-count">${voteCount} votes</span>
                            `;
                            collegeDiv.appendChild(row);
                        });
                    }
                    resultsContainer.appendChild(collegeDiv);
                }
                
            }, (error) => {
                // Gestion des erreurs de lecture (si les r√®gles sont incorrectement configur√©es)
                resultsContainer.innerHTML = `<p class="error">Erreur de lecture Firebase: ${error.message}. V√©rifiez les r√®gles de s√©curit√© de la base de donn√©es.</p>`;
            });
        }

        // D√©marrer la lecture au chargement de la page
        fetchResults();
    </script>
</body>
</html>
